<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KidBank üåü - Dashboard</title>
    <link rel="stylesheet" href="/css/kidbank.css">
    <style>
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            animation: slideIn 0.3s;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1f2937;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #374151;
        }

        .form-group select,
        .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            border-color: #8b5cf6;
        }

        .form-help {
            display: block;
            margin-top: 0.25rem;
            font-size: 0.875rem;
            color: #6b7280;
        }

        .wallet-input-group {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            margin-top: 0.5rem;
        }

        .wallet-input-group select {
            flex: 1;
        }

        .wallet-input-group button {
            padding: 0.75rem 1rem;
            white-space: nowrap;
            background-color: #8b5cf6;
            color: white;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.2s;
        }

        .wallet-input-group button:hover {
            background-color: #7c3aed;
        }

        .modal-buttons {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.5rem;
        }

        .modal-buttons button {
            flex: 1;
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-submit {
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
            color: white;
            border: none;
        }

        .btn-cancel {
            background: white;
            color: #6b7280;
            border: 2px solid #e5e7eb;
        }

        #transfer-message {
            margin-top: 1rem;
            padding: 0.75rem;
            border-radius: 0.5rem;
            display: none;
        }

        #transfer-message.success {
            display: block;
            background: #d1fae5;
            color: #065f46;
        }

        #transfer-message.error {
            display: block;
            background: #fee2e2;
            color: #991b1b;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <div class="header-left">
                <div class="header-icon">üí∞</div>
                <div class="header-title">
                    <h1>KidBank üåü</h1>
                    <p class="header-subtitle">Welcome back, <%- userName || 'Alex' %>!</p>
                </div>
            </div>
            <div class="stars-badge">
                <span>‚≠ê</span>
                <span><%- userStars || 245 %> Stars</span>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Tabs Navigation -->
        <div class="tabs-nav">
            <button class="tab-btn active" data-tab="home" onclick="switchTab('home')">
                <span>üè†</span>
                <span>Home</span>
            </button>
            <button class="tab-btn" data-tab="invest" onclick="switchTab('invest')">
                <span>üìà</span>
                <span>Invest</span>
            </button>
            <button class="tab-btn" data-tab="savings" onclick="switchTab('savings')">
                <span>üéØ</span>
                <span>Savings</span>
            </button>
            <button class="tab-btn" data-tab="tasks" onclick="switchTab('tasks')">
                <span>üèÜ</span>
                <span>Tasks</span>
            </button>
            <button class="tab-btn" data-tab="game" onclick="switchTab('game')">
                <span>üéÆ</span>
                <span>Game</span>
            </button>
            <button class="tab-btn" data-tab="history" onclick="switchTab('history')">
                <span>üïê</span>
                <span>History</span>
            </button>
        </div>

        <!-- HOME TAB -->
        <div id="home" class="tab-content active">
            <!-- Balance Card -->
            <div class="balance-card card">
                <div class="balance-card-content">
                    <div class="balance-header">
                        <div>
                            <p class="text-sm" style="color: #e9d5ff;">Your Total Balance</p>
                            <div class="balance-amount">$<%- userBalance %></div>
                        </div>
                        <div class="balance-icon">üê∑</div>
                    </div>

                    <div class="balance-month">
                        <div class="month-icon">üìà</div>
                        <div style="flex: 1;">
                            <p class="text-sm">This Month</p>
                            <p style="font-size: 1.125rem; font-weight: 600;">
                                <% if (parseFloat(monthGain) > 0) { %>
                                    +$<%- monthGain %> üéâ
                                <% } else if (parseFloat(monthGain) < 0) { %>
                                    -$<%- Math.abs(parseFloat(monthGain)).toFixed(2) %> üìâ
                                <% } else { %>
                                    $0.00
                                <% } %>
                            </p>
                        </div>
                    </div>

                    <div class="balance-buttons">
                        <button class="btn btn-primary" onclick="addMoney()">Add Money</button>
                        <button class="btn btn-secondary" onclick="showTransferModal()">Send Money</button>
                    </div>
                </div>
            </div>

            <!-- Investment Wallet Preview -->
            <div class="card" style="border: 2px solid #d1fae5;">
                <div class="card-title" style="color: #065f46;">
                    <span>üìà</span>
                    Investment Wallet üå±
                </div>
                <div class="investment-visual">
                    <div class="cloud">üå± Getting bigger!</div>
                    <div class="sun"></div>
                    <div class="tree-ground"></div>
                    <div class="tree">
                        <div class="tree-crown"></div>
                        <div class="tree-trunk"></div>
                    </div>
                </div>
            </div>

            <!-- Grid: Savings Goals and Tasks -->
            <div class="grid-2">
                <!-- Savings Goals Preview -->
                <div class="card" style="border: 2px solid #fce7f3;">
                    <div class="card-title" style="color: #9f1239;">
                        <span>üéØ</span>
                        My Savings Goals
                    </div>
                    
                    <% if (typeof savingsGoals !== 'undefined' && savingsGoals && savingsGoals.length > 0) { 
                        const displayGoals = savingsGoals.slice(0, 2);
                        displayGoals.forEach(function(goal) { %>
                            <div class="goal-item">
                                <div class="goal-header">
                                    <div class="goal-info">
                                        <div class="goal-icon" style="background: <%- goal.color || 'linear-gradient(135deg, #3b82f6, #06b6d4)' %>;">
                                            <%- goal.icon || 'üéØ' %>
                                        </div>
                                        <div>
                                            <p style="font-weight: 600;"><%- goal.name %></p>
                                            <p class="text-xs text-gray">$<%- goal.saved %> / $<%- goal.target %></p>
                                        </div>
                                    </div>
                                    <span class="text-sm text-gray"><%- Math.round((goal.saved / goal.target) * 100) %>%</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: <%- (goal.saved / goal.target) * 100 %>%;"></div>
                                </div>
                            </div>
                        <% }); 
                    } else { %>
                        <!-- Default goals if no data from backend -->
                        <div class="goal-item">
                            <div class="goal-header">
                                <div class="goal-info">
                                    <div class="goal-icon" style="background: linear-gradient(135deg, #3b82f6, #06b6d4);">üéÆ</div>
                                    <div>
                                        <p style="font-weight: 600;">New Video Game</p>
                                        <p class="text-xs text-gray">$45 / $60</p>
                                    </div>
                                </div>
                                <span class="text-sm text-gray">75%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: 75%;"></div>
                            </div>
                        </div>
                    <% } %>
                </div>

                <!-- Tasks & Rewards Preview -->
                <div class="card" style="border: 2px solid #fef3c7;">
                    <div class="card-title" style="color: #92400e;">
                        <span>üèÜ</span>
                        Tasks & Rewards
                    </div>
                    
                    <% if (typeof tasks !== 'undefined' && tasks && tasks.length > 0) { 
                        const displayTasks = tasks.slice(0, 2);
                        displayTasks.forEach(function(task) { %>
                            <div class="task-item <%- task.completed ? 'completed' : '' %>" style="background: linear-gradient(90deg, white, #fef9c3);">
                                <div class="task-left">
                                    <div class="task-icon" style="background: <%- task.color || 'linear-gradient(135deg, #fbbf24, #f59e0b)' %>;">
                                        <%- task.icon || 'üè†' %>
                                    </div>
                                    <div>
                                        <p style="font-weight: 600;"><%- task.name %></p>
                                        <p class="text-xs text-gray">
                                            <span style="color: #16a34a;">$<%- task.reward %></span> ‚Ä¢ ‚≠ê <%- task.stars %>
                                        </p>
                                    </div>
                                </div>
                                <button class="task-complete-btn <%- task.completed ? 'completed' : '' %>" 
                                        onclick="completeTask(this, '<%- task.id %>')">‚úì</button>
                            </div>
                        <% }); 
                    } else { %>
                        <!-- Default tasks if no data from backend -->
                        <div class="task-item" style="background: linear-gradient(90deg, white, #fef9c3);">
                            <div class="task-left">
                                <div class="task-icon" style="background: linear-gradient(135deg, #fbbf24, #f59e0b);">üè†</div>
                                <div>
                                    <p style="font-weight: 600;">Clean my room</p>
                                    <p class="text-xs text-gray"><span style="color: #16a34a;">$5</span> ‚Ä¢ ‚≠ê 10</p>
                                </div>
                            </div>
                            <button class="task-complete-btn" onclick="completeTask(this, 'task-1')">‚úì</button>
                        </div>
                    <% } %>
                </div>
            </div>

            <!-- Recent Transactions Preview -->
            <div class="card" style="border: 2px solid #e9d5ff;">
                <div class="card-title" style="color: #6b21a8;">
                    <span>üïê</span>
                    Recent Activity
                </div>
                
                <% if (!transactions || transactions.length === 0) { %>
                    <p class="text-muted">No transactions yet.</p>
                <% } else { %>
                    <div class="transactions-list">
                        <% transactions.forEach(function(tx) { %>
                            <div class="transaction-item">
                                <div class="transaction-info">
                                    <span class="transaction-type">
                                        <% if (tx.from_wallet_id === wallet.id) { %>
                                            Sent to User #<%= tx.to_user_id %>
                                        <% } else { %>
                                            Received from User #<%= tx.from_user_id %>
                                        <% } %>
                                    </span>
                                    <% if (tx.description) { %>
                                        <span class="transaction-desc"><%= tx.description %></span>
                                    <% } %>
                                </div>
                                <div class="transaction-amount <%= tx.from_wallet_id === wallet.id ? 'amount-negative' : 'amount-positive' %>">
                                    <%= tx.from_wallet_id === wallet.id ? '-' : '+' %>$<%= tx.amount.toFixed(2) %>
                                </div>
                                <div class="transaction-date">
                                    <%= new Date(tx.created_at).toLocaleString() %>
                                </div>
                            </div>
                        <% }); %>
                    </div>
                <% } %>
            </div>
        </div>

        <!-- INVEST TAB -->
        <div id="invest" class="tab-content">
            <div class="card" style="border: 2px solid #d1fae5;">
                <div class="card-title" style="color: #065f46;">
                    <span>üìà</span>
                    Investment Wallet üå±
                </div>

                <div class="investment-visual">
                    <div class="cloud">üå± Getting bigger!</div>
                    <div class="sun"></div>
                    <div class="tree-ground"></div>
                    <div class="tree">
                        <div class="tree-crown"></div>
                        <div class="tree-trunk"></div>
                    </div>
                </div>

                <div class="investment-balance">
                    <p class="text-sm" style="color: rgba(255,255,255,0.8);">Your Investment Balance</p>
                    <h2 style="font-size: 2rem; margin: 0.5rem 0;">$<%- typeof investmentBalance !== 'undefined' ? investmentBalance : '85.75' %></h2>
                    <div class="investment-earnings">
                        <div class="earnings-icon">üí∞</div>
                        <div>
                            <p class="text-sm" style="color: rgba(255,255,255,0.9);">Total Earnings</p>
                            <p style="font-weight: 600; font-size: 1.125rem;">+$<%- typeof investmentEarnings !== 'undefined' ? investmentEarnings : '5.75' %> ü§ë</p>
                        </div>
                    </div>
                </div>

                <h3 style="margin: 1.5rem 0 1rem; font-size: 1.125rem;">Choose Your Investment üéØ</h3>

                <div class="investment-option selected">
                    <div class="option-icon" style="background: #10b981; color: white;">üå±</div>
                    <div class="option-info">
                        <div class="option-name">Safe Garden üå±</div>
                        <div class="option-desc">Slow and steady growth</div>
                        <div class="option-details">
                            <span class="badge badge-success">3% per month</span>
                            <span class="badge badge-info">Very Low Risk</span>
                        </div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-top: 1rem;">
                    <button class="btn" style="background: #10b981; color: white;" onclick="addInvestmentMoney()">+ Add Money</button>
                    <button class="btn" style="background: white; border: 2px solid #10b981; color: #10b981;" onclick="withdrawInvestment()">‚äñ Withdraw</button>
                </div>
            </div>
        </div>

        <!-- SAVINGS TAB -->
        <div id="savings" class="tab-content">
            <div class="card" style="border: 2px solid #fce7f3;">
                <div class="card-title" style="color: #9f1239;">
                    <span>üéØ</span>
                    My Savings Goals
                </div>

                <% if (typeof savingsGoals !== 'undefined' && savingsGoals && savingsGoals.length > 0) { 
                    savingsGoals.forEach(function(goal) { %>
                        <div class="goal-item">
                            <div class="goal-header">
                                <div class="goal-info">
                                    <div class="goal-icon" style="background: <%- goal.color %>;">
                                        <%- goal.icon %>
                                    </div>
                                    <div>
                                        <p style="font-weight: 600; font-size: 1.125rem;"><%- goal.name %></p>
                                        <p class="text-sm text-gray">$<%- goal.saved %> / $<%- goal.target %></p>
                                    </div>
                                </div>
                                <span style="font-weight: 600; color: #6b7280;"><%- Math.round((goal.saved / goal.target) * 100) %>%</span>
                            </div>
                            <div class="progress-bar" style="height: 10px;">
                                <div class="progress-fill" style="width: <%- (goal.saved / goal.target) * 100 %>%;"></div>
                            </div>
                        </div>
                    <% }); 
                } %>

                <button class="btn" style="width: 100%; margin-top: 1rem; background: linear-gradient(90deg, #ec4899, #a855f7); color: white; font-size: 1.125rem;" onclick="addNewGoal()">
                    + Add New Goal
                </button>
            </div>
        </div>

        <!-- TASKS TAB -->
        <div id="tasks" class="tab-content">
            <div class="card" style="border: 2px solid #fef3c7;">
                <div class="card-title" style="color: #92400e;">
                    <span>üèÜ</span>
                    Tasks & Rewards
                </div>

                <% if (typeof tasks !== 'undefined' && tasks && tasks.length > 0) { 
                    tasks.forEach(function(task) { %>
                        <div class="task-item <%- task.completed ? 'completed' : '' %>" style="background: linear-gradient(90deg, white, #fef9c3);">
                            <div class="task-left">
                                <div class="task-icon" style="background: <%- task.color %>;">
                                    <%- task.icon %>
                                </div>
                                <div>
                                    <p style="font-weight: 600; font-size: 1.125rem;"><%- task.name %></p>
                                    <p class="text-sm" style="color: #6b7280;">
                                        <span style="color: #16a34a; font-weight: 600;">$<%- task.reward %></span> ‚Ä¢ ‚≠ê <%- task.stars %>
                                    </p>
                                </div>
                            </div>
                            <button class="task-complete-btn <%- task.completed ? 'completed' : '' %>" 
                                    onclick="completeTask(this, '<%- task.id %>')">‚úì</button>
                        </div>
                    <% }); 
                } %>
            </div>
        </div>

        <!-- GAME TAB -->
        <div id="game" class="tab-content">
            <div class="game-stats">
                <div class="game-header">
                    <div>
                        <p class="text-sm" style="color: #e9d5ff;">Your Game Level</p>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span class="game-level">Level <%- typeof gameLevel !== 'undefined' ? gameLevel : 12 %></span>
                            <span style="font-size: 2rem;">üëë</span>
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <p class="text-sm" style="color: #e9d5ff;">Total Coins</p>
                        <p style="font-size: 1.5rem; font-weight: 600;"><%- typeof totalCoins !== 'undefined' ? totalCoins : 1250 %> ü™ô</p>
                    </div>
                </div>

                <div class="game-grid">
                    <div class="game-stat">
                        <div class="stat-icon">üèÜ</div>
                        <p class="text-xs" style="color: #e9d5ff;">Achievements</p>
                        <p style="font-weight: 600;"><%- typeof achievementsUnlocked !== 'undefined' ? achievementsUnlocked : 8 %>/20</p>
                    </div>
                    <div class="game-stat">
                        <div class="stat-icon">‚ö°</div>
                        <p class="text-xs" style="color: #e9d5ff;">Day Streak</p>
                        <p style="font-weight: 600;"><%- typeof dayStreak !== 'undefined' ? dayStreak : 5 %> days üî•</p>
                    </div>
                    <div class="game-stat">
                        <div class="stat-icon">‚≠ê</div>
                        <p class="text-xs" style="color: #e9d5ff;">Stars</p>
                        <p style="font-weight: 600;"><%- typeof userStars !== 'undefined' ? userStars : 245 %> ‚≠ê</p>
                    </div>
                </div>
            </div>

            <div class="card" style="border: 2px solid #e9d5ff;">
                <div class="card-title" style="color: #6b21a8;">
                    <span>üéÆ</span>
                    Level Progress üéÆ
                </div>
                <p>Your game levels will appear here from the backend data</p>
            </div>
        </div>

        <!-- HISTORY TAB -->
        <div id="history" class="tab-content">
            <div class="card" style="border: 2px solid #e9d5ff;">
                <div class="card-title" style="color: #6b21a8;">
                    <span>üïê</span>
                    Recent Activity
                </div>

                <% if (!transactions || transactions.length === 0) { %>
                    <p class="text-muted">No transactions yet.</p>
                <% } else { 
                    transactions.forEach(function(tx) { %>
                        <div class="transaction-item">
                            <div class="transaction-left">
                                <div class="transaction-icon" style="background: <%= tx.from_wallet_id === wallet.id ? '#ea580c' : '#22c55e' %>; color: white;">
                                    <%= tx.from_wallet_id === wallet.id ? '‚Üë' : '‚Üì' %>
                                </div>
                                <div>
                                    <p style="font-weight: 600; font-size: 1.125rem;">
                                        <%= tx.from_wallet_id === wallet.id ? 'Sent to User #' + tx.to_user_id : 'Received from User #' + tx.from_user_id %>
                                    </p>
                                    <% if (tx.description) { %>
                                        <p class="text-sm text-gray"><%= tx.description %></p>
                                    <% } %>
                                    <p class="text-sm text-gray"><%= new Date(tx.created_at).toLocaleString() %></p>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span class="transaction-amount <%= tx.from_wallet_id === wallet.id ? 'amount-negative' : 'amount-positive' %>">
                                    <%= tx.from_wallet_id === wallet.id ? '-' : '+' %>$<%= tx.amount.toFixed(2) %>
                                </span>
                            </div>
                        </div>
                    <% }); 
                } %>
            </div>
        </div>
    </div>

    <!-- Transfer Modal -->
    <div id="transferModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üí∏ Send Money</h2>
                <button class="modal-close" onclick="closeTransferModal()">‚úï</button>
            </div>
            
            <form id="transfer-form">
                <div class="form-group">
                    <label for="from_user">From Account:</label>
                    <select id="from_user" name="from_user_id" required>
                        <option value="<%= typeof user !== 'undefined' ? user.id : '' %>">
                            My Account ($<%= typeof wallet !== 'undefined' ? wallet.balance.toFixed(2) : '0.00' %>)
                        </option>
                        <% if (typeof children !== 'undefined' && children) { 
                            children.forEach(function(child) { %>
                                <option value="<%= child.id %>">
                                    <%= child.full_name %> ($<%= child.wallet.balance.toFixed(2) %>)
                                </option>
                            <% }); 
                        } %>
                    </select>
                </div>

                <div class="form-group">
                    <label for="to_user">To Account:</label>
                    <div class="wallet-input-group">
                        <select id="to_user" name="to_user_id" required>
                            <option value="<%= typeof user !== 'undefined' ? user.id : '' %>">My Account</option>
                            <% if (typeof children !== 'undefined' && children) { 
                                children.forEach(function(child) { %>
                                    <option value="<%= child.id %>"><%= child.full_name %></option>
                                <% }); 
                            } %>
                        </select>
                        <button type="button" class="btn-secondary" onclick="showAddWalletModal()">+ New Wallet</button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="amount">Amount:</label>
                    <input type="number" id="amount" name="amount" step="0.01" min="0.01" placeholder="0.00" required>
                </div>

                <div class="form-group">
                    <label for="description">Description (optional):</label>
                    <input type="text" id="description" name="description" placeholder="What's this for?">
                </div>

                <div id="transfer-message"></div>

                <div class="modal-buttons">
                    <button type="button" class="btn-cancel" onclick="closeTransferModal()">Cancel</button>
                    <button type="submit" class="btn-submit">Send Money üí∏</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Wallet Modal -->
    <div id="addWalletModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">‚ûï Add New Wallet</h2>
                <button class="modal-close" onclick="closeAddWalletModal()">‚úï</button>
            </div>
            
            <form id="add-wallet-form">
                <div class="form-group">
                    <label for="wallet_name">Wallet Name:</label>
                    <input type="text" id="wallet_name" name="wallet_name" placeholder="Enter a name for this wallet" required>
                </div>

                <div class="form-group">
                    <label for="wallet_address">Wallet Address:</label>
                    <input type="text" id="wallet_address" name="wallet_address" 
                           placeholder="https://ilp.interledger-test.dev/your-wallet-id" 
                           pattern="https?://.*interledger.*"
                           title="Must be a valid Interledger URL (e.g., https://ilp.interledger-test.dev/...)"
                           required>
                    <small class="form-help">Enter a valid Interledger URL (starts with https:// and contains interledger)</small>
                </div>

                <div id="wallet-message"></div>

                <div class="modal-buttons">
                    <button type="button" class="btn-cancel" onclick="closeAddWalletModal()">Cancel</button>
                    <button type="submit" class="btn-submit">Add Wallet ‚ûï</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Chatbot -->
    <button class="chatbot-button" onclick="toggleChatbot()">üí¨</button>

    <div class="chatbot-window" id="chatbot">
        <div class="chatbot-header">
            <div class="chatbot-title">
                <div class="chatbot-avatar">‚ú®</div>
                <div>
                    <div style="font-weight: 600;">MoneyBot ü§ñ</div>
                    <p style="font-size: 0.75rem; opacity: 0.9;">Your Money Helper</p>
                </div>
            </div>
            <button class="chatbot-close" onclick="toggleChatbot()">‚úï</button>
        </div>

        <div class="chatbot-messages" id="chatMessages">
            <div class="message bot">
                <div class="message-bubble">
                    Hi there! üëã I'm MoneyBot, your friendly money helper! Ask me anything about saving, spending, or investing!
                </div>
            </div>
        </div>

        <div class="chatbot-input-area">
            <div class="chatbot-input">
                <input type="text" id="chatInput" placeholder="Ask me anything! üí≠" onkeypress="handleChatKeypress(event)">
                <button class="chatbot-send" onclick="sendMessage()">‚û§</button>
            </div>
            <p class="text-xs text-gray" style="margin-top: 0.5rem; text-align: center;">
                Try asking: "How do I save money?" üí°
            </p>
        </div>
    </div>

    <script src="/js/kidbank.js"></script>
    <script>
        // Transfer Modal Functions
        function showTransferModal() {
            document.getElementById('transferModal').classList.add('active');
        }

        function closeTransferModal() {
            document.getElementById('transferModal').classList.remove('active');
            document.getElementById('transfer-form').reset();
            document.getElementById('transfer-message').style.display = 'none';
        }

        // Transfer Form Handler (MISMA L√ìGICA QUE DASHBOARD ORIGINAL)
        document.getElementById('transfer-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const data = {
                from_user_id: formData.get('from_user_id'),
                to_user_id: formData.get('to_user_id'),
                amount: parseFloat(formData.get('amount')),
                description: formData.get('description') || ''
            };

            // Validaci√≥n b√°sica
            if (data.from_user_id === data.to_user_id) {
                showMessage('error', '‚ùå Cannot transfer to the same account!');
                return;
            }

            try {
                const response = await fetch('/dashboard/transfer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    showMessage('success', '‚úÖ ' + result.message);
                    setTimeout(() => {
                        closeTransferModal();
                        location.reload();
                    }, 1500);
                } else {
                    showMessage('error', '‚ùå ' + (result.error || 'Transfer failed'));
                }
            } catch (error) {
                console.error('Error:', error);
                showMessage('error', '‚ùå Failed to process transfer. Please try again.');
            }
        });

        function showMessage(type, message) {
            const messageDiv = document.getElementById('transfer-message');
            messageDiv.className = type;
            messageDiv.textContent = message;
            messageDiv.style.display = 'block';
        }

        // Cerrar modal al hacer clic fuera de √©l
        document.getElementById('transferModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeTransferModal();
            }
        });

        // Task completion function
        function completeTask(button, taskId) {
            const taskItem = button.closest('.task-item');
            const taskText = taskItem.querySelector('p');
            
            fetch('/dashboard/api/complete-task', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ taskId: taskId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    taskItem.classList.add('completed');
                    button.classList.add('completed');
                    taskText.style.textDecoration = 'line-through';
                    button.innerHTML = '‚úì';
                    
                    setTimeout(() => {
                        alert('üéâ Great job! You earned $' + data.earnedMoney + ' and ' + data.earnedStars + ' stars!');
                    }, 300);
                }
            })
            .catch(error => console.error('Error:', error));
        }

        // Add Money function
        async function addMoney() {
            const amount = prompt('How much money do you want to add?');
            if (amount && !isNaN(amount) && amount > 0) {
                try {
                    const response = await fetch('/dashboard/api/add-money', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            amount: amount,
                            description: 'Added from KidBank'
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.requiresInteraction) {
                        alert('Waiting for parent approval! You will be redirected.');
                        window.location.href = data.interactUrl;
                    } else if (data.success) {
                        alert('üí∞ ' + data.message);
                        location.reload();
                    } else {
                        alert('Error: ' + (data.error || 'Failed to add money'));
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Failed to add money. Please try again.');
                }
            }
        }

        function addInvestmentMoney() {
            alert('üìà Investment feature coming soon!');
        }

        function withdrawInvestment() {
            alert('‚äñ Withdraw investment - connect to your backend!');
        }

        function addNewGoal() {
            alert('üéØ Add new goal - connect to your backend!');
        }
    </script>
</body>
</html>